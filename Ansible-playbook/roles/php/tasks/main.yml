- name: Upgrade System
  apt: upgrade=dist update_cache=yes

- name: Add php repository
  apt_repository:
   repo: 'ppa:ondrej/php'

- name: Install PHP
  apt: name=php{{php_version}} state=latest

- name: Install PHP MB
  apt: name=php{{php_version}}-mbstring state=latest

- name: Install PHP XML
  apt: name=php-xml state=latest

- name: Install unzip
  apt: name=unzip state=latest

- name: Download php-composer
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/installer

- name: install composer
  shell: cat /tmp/installer | php -- --install-dir=/usr/local/bin
  args:
    creates: /usr/local/bin/composer

- name: rename composer.phar to composer
  shell: mv /usr/local/bin/composer.phar /usr/local/bin/composer
  args:
    creates: /usr/local/bin/composer

- name: make composer executable
  file: 
    path: /usr/local/bin/composer
    mode: a+x
    state: file

- name: install apache2 server
  apt:
     name: apache2
     state: present

- name: install php curl 
  shell: sudo apt-get install php-curl -y

- name: install php 8.0 repo
  shell: echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/php.list
  shell: sudo apt update -y
  shell: sudo apt install -y php8.0-common php8.0-cli -y

- name: install lamp stack
  apt:
    pkg:
      - php8.0-mysql
      - php8.0-curl
      - php8.0-cgi
      - php8.0-xsl
      - php8.0-gd
      - php8.0-mbstring
      - php8.0-zip
      - php8.0-xmlrpc
      - php8.0-soap
      - php8.0-intl
      - libapache2-mod-php
    state: present
    update_cache: yes 

- name: Install dependencies for PostgreSQL
  apt: name={{ item }} update_cache=true state=latest
  with_items:
    - bash
    - openssl
    - libssl-dev
    - libssl-doc
 
- name: Install PostgreSQL 
  apt: name={{ item }} update_cache=true state=present
  with_items:
    - postgresql
    - postgresql-contrib
    - libpq-dev
    - python3-psycopg2

- name: Ensure the PostgreSQL service is running
  service: name=postgresql state=started enabled=yes

- name: Create the database specified in vars
  become: true
  become_user: postgres
  postgresql_db: name={{ db_name }}
       template='template0'
        state=present
 
- name: Ensure user has access to the new database
  become: true
  become_user: postgres
  postgresql_user: db={{ db_name }}
      name={{ db_user }}
      password={{ db_password }}
      priv=ALL
      state=present
  
- name: Ensure user does not have unnecessary permissions
  become: true
  become_user: postgres
  postgresql_user: name={{ db_user }}
      role_attr_flags=NOSUPERUSER,NOCREATEDB
      state=present

- name: remove laravelrepo 
  shell: sudo rm -rf /var/www/html/{{ vhost_name }}/

- name: checkout latest code from github
  git: >
    repo=https://github.com/f1amy/laravel-realworld-example-app.git
    dest=/opt/{{ vhost_name }}
    force=yes
    accept_hostkey=yes

- name: copy laravelrepo
  shell: sudo mv -f /opt/{{ vhost_name }} /var/www/html/

- name: permission for composer install
  shell: sudo chmod -R 777 /var/www/html/{{ vhost_name }}/

- name: remove default webphp from routes
  shell: sudo rm -rf /var/www/html/{{ vhost_name }}/routes/web.php

- name: create web.php in routes
  template: src=webphp dest="/var/www/html/{{ vhost_name }}/routes/web.php"

- name: "Composer install"
  become: false
  composer:
    command: install 
    global_command: false  
    working_dir: /var/www/html/{{ vhost_name }}/

- name: Change permission
  shell: sudo chown -R www-data:www-data /var/www/html/{{ vhost_name }}/

- name: Change permission for storage
  shell: sudo chmod -R 775 /var/www/html/{{ vhost_name }}/storage

- name: Create .env file for database
  template: src=env.example dest="/var/www/html/{{ vhost_name }}/.env"

- name: To change artisan file permission
  shell: sudo chmod 777 /var/www/html/{{ vhost_name }}/artisan

- name: To generate artisan key
  shell: php /var/www/html/{{ vhost_name }}/artisan key:generate

- name: update and upgrade
  shell: sudo apt update && sudo apt upgrade -y

- name: run migration
  shell: php /var/www/html/{{ vhost_name }}/artisan migrate

#- name: run migration seed
#  shell: php /var/www/html/{{ vhost_name }}/artisan migrate --seed

#- name: run migration refresh
#  shell: php /var/www/html/{{ vhost_name }}/artisan migrate:refresh --seed 

#- name: run migration
#  shell: php /var/www/html/{{ vhost_name }}/artisan migrate:fresh

- name: Remove default apache vhost config from sites-enabled
  file: name=/etc/apache2/sites-enabled/000-default.conf state=absent

- name: Create apache vhosts for  domain
  template: src=web.conf.j2 dest="/etc/apache2/sites-available/{{ vhost_name }}.conf" 

- name: permission for laravel conf file
  shell: sudo chmod -R 777 /etc/apache2/sites-available/{{ vhost_name }}.conf

- name: Update a2ensite
  command: a2ensite {{ vhost_name }}

- name: Enable the Apache rewrite module
  command:  a2enmod rewrite

  notify:
    - restart apache2
